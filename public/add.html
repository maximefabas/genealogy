<!DOCTYPE html>
<html lang="fr">
  
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Genealogy - Add human</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css">
  </head>

  <body>
    <h1>Ajouter un aÃ¯eul</h1>
    PrÃ©nom <input type="text" name="first-name" /><br />
    PrÃ©nom usuel <input type="text" name="common-first-name" /><br />
    Nom de naissance <input type="text" name="birth-last-name" /><br />
    Nom <input type="text" name="last-name" /><br />
    Genre <select name="gender">
      <option value="">â€“</option>
      <option value="F">F</option>
      <option value="M">M</option>
      <option value="NB">NB</option>
    </select><br /><br />

    Date de naissance <input type="date" name="birth-date" /><br />
    Lieu de naissance <input type="text" name="birth-place" /><br />
    Date de dÃ©cÃ¨s <input type="date" name="death-date" /><br />
    Lieu de dÃ©cÃ¨s <input type="text" name="death-place" /><br /><br />

    Parent 1 <select name="parent-1">
      <option value="">â€“</option>
    </select><br />
    Parent 2 <select name="parent-2">
      <option value="">â€“</option>
    </select><br /><br />

    <button id="cancel" onclick="cancelForm()">Annuler</button>
    <button id="send" onclick="sendHuman()">Donner la vie Ã  cet humain *</button>
    <button id="kill" onclick="killHuman()">Tuer cet humain *</button><br />
    <i style="font-size: .5rem;">* dans la base de donnÃ©es uniquement</i>

    <div id="humans-list">
    </div>

    <script>
      const state = {
        humans: [],
        editing: null
      }

      fetchAndPrefill()

      async function fetchAndPrefill () {
        await fetchAll()
        fillTemplate()
      }

      async function fetchAll () {
        // No error handling ðŸ˜Ž
        const res = await window.fetch('/api/list-humans')
        const data = await res.json()
        const humans = data.data
        state.humans = [...humans]
        return humans
      }

      function fillTemplate () {
        const $parent1 = document.querySelector('select[name="parent-1"]')
        const $parent2 = document.querySelector('select[name="parent-2"]')
        const $humansList = document.querySelector('#humans-list')
        const defaultOption = '<option value="">â€“</option>'
        $parent1.innerHTML = defaultOption
        $parent2.innerHTML = defaultOption
        $humansList.innerHTML = ''
        state.humans.forEach(human => {
          const option = `<option value=${human._id}>${human.common_first_name ||Â human.first_name} ${human.last_name ||Â human.birth_last_name} (${human.birth_date})</option>`
          const humanSummary = `<p onclick="triggerEdition('${human._id}')">
            ${human.common_first_name || human.first_name} ${human.last_name || human.birth_last_name} (${human.gender})<br />
            nÃ©Â·e ${human.first_name} ${human.birth_last_name}<br />
            nÃ©Â·e le ${human.birth_date ||Â '-'} Ã  ${human.birth_place ||Â '-'},<br />
            ${human.death_date ? `dÃ©cÃ©dÃ©Â·e le ${human.death_date ||Â '-'} Ã  ${human.death_place ||Â '-'}<br />` : ''}
            enfant de ${getFullNameViaId(human.parent_1) ||Â '-'} et de ${getFullNameViaId(human.parent_2) ||Â '-'}<br />
            <button onclick="triggerEdition('${human._id}')">Modifier</button>
          </p>`
          $parent1.innerHTML += option
          $parent2.innerHTML += option
          $humansList.innerHTML += humanSummary
        })
      }

      function cancelForm () {
        state.editing = null
        const $pageTitle = document.querySelector('h1')
        $pageTitle.innerHTML = 'Ajouter un aÃ¯eul'
        document.querySelector('input[name="first-name"]').value = ''
        document.querySelector('input[name="common-first-name"]').value = ''
        document.querySelector('input[name="last-name"]').value = ''
        document.querySelector('input[name="birth-last-name"]').value = ''
        document.querySelector('select[name="gender"]').value = ''
        document.querySelector('input[name="birth-date"]').value = ''
        document.querySelector('input[name="birth-place"]').value = ''
        document.querySelector('input[name="death-date"]').value = ''
        document.querySelector('input[name="death-place"]').value = ''
        document.querySelector('select[name="parent-1"]').value = ''
        document.querySelector('select[name="parent-2"]').value = ''
        document.querySelector('#send').innerHTML = 'Donner la vie Ã  cet humain *'
      }

      async function sendHuman () {
        const firstName = document.querySelector('input[name="first-name"]').value
        const commonFirstName = document.querySelector('input[name="common-first-name"]').value
        const lastName = document.querySelector('input[name="last-name"]').value
        const birthLastName = document.querySelector('input[name="birth-last-name"]').value
        const gender = document.querySelector('select[name="gender"]').value
        const birthDate = document.querySelector('input[name="birth-date"]').value
        const birthPlace = document.querySelector('input[name="birth-place"]').value
        const deathDate = document.querySelector('input[name="death-date"]').value
        const deathPlace = document.querySelector('input[name="death-place"]').value
        const parent1 = document.querySelector('select[name="parent-1"]').value
        const parent2 = document.querySelector('select[name="parent-2"]').value
        const newHuman = {
          first_name: firstName,
          common_first_name: commonFirstName,
          last_name: lastName,
          birth_last_name: birthLastName,
          gender,
          birth_date: birthDate,
          birth_place: birthPlace,
          death_date: deathDate,
          death_place: deathPlace,
          parent_1: parent1,
          parent_2: parent2
        }

        if (state.editing) {
          const res = await window.fetch(`/api/edit-human/${state.editing}`, {
            method: 'POST',
            body: JSON.stringify(newHuman),
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            }
          })
          const { dataÂ } = await res.json()
          state.humans = [
            ...state.humans.filter(human => human._id !== state.editing),
            data
          ]
          cancelForm()
          fillTemplate()
        } else {
          const res = await window.fetch('/api/create-human', {
            method: 'POST',
            body: JSON.stringify(newHuman),
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            }
          })
          const { dataÂ } = await res.json()
          state.humans = [...state.humans, data]
          cancelForm()
          fillTemplate()
        }
      }

      async function killHuman ()Â {
        alert('Not functional yet.')
      }

      function getHumanViaId (id) {
        const human = state.humans.find(human => human._id === id)
        return human
      }

      function getFullNameViaId (id) {
        const human = getHumanViaId(id)
        if (!human) return
        return `${human.common_first_name ||Â human.first_name} ${human.last_name || human.birth_last_name}`
      }

      function triggerEdition (id) {
        const human = getHumanViaId(id)
        if (!human) return
        state.editing = id
        const $pageTitle = document.querySelector('h1')
        $pageTitle.innerHTML = `Modification de ${human.first_name} ${human.last_name}`
        document.querySelector('input[name="first-name"]').value = human.first_name
        document.querySelector('input[name="common-first-name"]').value = human.common_first_name
        document.querySelector('input[name="last-name"]').value = human.last_name
        document.querySelector('input[name="birth-last-name"]').value = human.birt_last_name
        document.querySelector('select[name="gender"]').value = human.gender
        document.querySelector('input[name="birth-date"]').value = human.birth_date
        document.querySelector('input[name="birth-place"]').value = human.birth_place
        document.querySelector('input[name="death-date"]').value = human.death_date
        document.querySelector('input[name="death-place"]').value = human.death_place
        document.querySelector('select[name="parent-1"]').value = human.parent_1
        document.querySelector('select[name="parent-2"]').value = human.parent_2
        document.querySelector('#send').innerHTML = 'Changer le destin de cet humain *'
        window.scrollTo(0, 0)
      }
    </script>
  </body>

</html>
